name: YouTube Playlist Downloader (Cookies)
on:
  workflow_dispatch:
    inputs:
      playlist_url:
        description: 'URL de la playlist YouTube'
        required: true
      quality:
        description: 'QualitÃ© vidÃ©o'
        required: true
        default: '720p'
        type: choice
        options:
        - 1080p
        - 720p
        - 480p

jobs:
  youtube-downloader:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Install YouTube Tools
      run: |
        echo "ðŸ”§ Installation des outils..."
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip aria2
        pip3 install yt-dlp[default]
        
    - name: Setup Cookies from Secret
      run: |
        echo "ðŸª Configuration des cookies YouTube..."
        # CrÃ©er le fichier cookies Ã  partir du secret
        echo '${{ secrets.YOUTUBE_COOKIES }}' > cookies.txt
        
        # VÃ©rifier que le fichier cookies est valide
        if [ -s cookies.txt ]; then
          echo "âœ… Cookies chargÃ©s avec succÃ¨s"
          echo "ðŸ“„ PremiÃ¨res lignes des cookies:"
          head -5 cookies.txt
        else
          echo "âŒ Erreur: Fichier cookies vide"
          exit 1
        fi
        
    - name: Configure Maximum Speed
      run: |
        echo "âš¡ Configuration vitesse 1Gbps..."
        mkdir -p ~/.config/yt-dlp
        cat > ~/.config/yt-dlp/config << EOF
        --cookies cookies.txt
        --no-mtime
        --no-overwrites
        --continue
        --concurrent-fragments 16
        --http-chunk-size 50M
        --external-downloader aria2c
        --external-downloader-args "-x 16 -k 1M -s 16 -j 16"
        --limit-rate 500M
        --retries 10
        --fragment-retries 10
        --ignore-errors
        EOF
        
    - name: Download Playlist with Cookies
      run: |
        echo "ðŸŽ¬ TÃ©lÃ©chargement avec cookies..."
        
        # Configuration qualitÃ©
        if [ "${{ inputs.quality }}" = "1080p" ]; then
          FORMAT="bestvideo[height<=1080]+bestaudio/best[height<=1080]"
        elif [ "${{ inputs.quality }}" = "720p" ]; then
          FORMAT="bestvideo[height<=720]+bestaudio/best[height<=720]"
        elif [ "${{ inputs.quality }}" = "480p" ]; then
          FORMAT="bestvideo[height<=480]+bestaudio/best[height<=480]"
        else
          FORMAT="bestvideo[height<=720]+bestaudio/best[height<=720]"
        fi
        
        # TÃ©lÃ©chargement avec cookies et vitesse max
        yt-dlp \
          --cookies cookies.txt \
          --format "$FORMAT" \
          --merge-output-format mp4 \
          --output "playlist_videos/%(playlist_title)s/%(title)s.%(ext)s" \
          --concurrent-fragments 32 \
          --external-downloader aria2c \
          --external-downloader-args "-x 32 -k 2M -s 32 -j 32" \
          --ignore-errors \
          --print-after-download "âœ… TÃ©lÃ©chargÃ©: %(title)s" \
          "${{ inputs.playlist_url }}"
          
        echo "ðŸ“Š RÃ©sumÃ© du tÃ©lÃ©chargement..."
        
    - name: Create Organized ZIP
      run: |
        echo "ðŸ—œï¸ CrÃ©ation de l'archive ZIP..."
        
        # CrÃ©er un nom d'archive avec timestamp
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        ZIP_NAME="youtube_playlist_${TIMESTAMP}.zip"
        
        # ZIP avec compression maximale
        zip -r "${ZIP_NAME}" "playlist_videos/" -9
        
        # Statistiques
        VIDEO_COUNT=$(find playlist_videos/ -name "*.mp4" | wc -l)
        ZIP_SIZE=$(du -h "${ZIP_NAME}" | cut -f1)
        
        echo "ðŸ“¦ Archive: ${ZIP_NAME}"
        echo "ðŸŽ¬ VidÃ©os tÃ©lÃ©chargÃ©es: ${VIDEO_COUNT}"
        echo "ðŸ’¾ Taille: ${ZIP_SIZE}"
        
    - name: Upload ZIP Artifact
      uses: actions/upload-artifact@v4
      with:
        name: youtube-playlist
        path: youtube_playlist_*.zip
        retention-days: 30
        compression-level: 9
        
    - name: Cleanup Cookies
      run: |
        echo "ðŸ§¹ Nettoyage des cookies..."
        rm -f cookies.txt
        echo "âœ… Cookies supprimÃ©s"
        
    - name: Final Summary
      run: |
        echo " "
        echo "ðŸŽ‰ TÃ‰LÃ‰CHARGEMENT TERMINÃ‰ !"
        echo "==================================="
        echo "ðŸ“¹ Playlist: ${{ inputs.playlist_url }}"
        echo "ðŸŽ¯ QualitÃ©: ${{ inputs.quality }}"
        echo "ðŸ’¾ Archive: youtube_playlist_*.zip"
        echo "ðŸª Cookies: UtilisÃ©s avec succÃ¨s"
        echo "ðŸš€ Vitesse: Connexion 1Gbps GitHub"
        echo "â¬‡ï¸ TÃ©lÃ©charge le ZIP dans 'Artifacts' â†‘"
        echo "==================================="
