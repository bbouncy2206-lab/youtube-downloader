name: YouTube Playlist to ZIP Downloader
on:
  workflow_dispatch:
    inputs:
      playlist_url:
        description: 'URL de la playlist YouTube'
        required: true
        default: 'https://youtube.com/playlist?list=XXX'
      quality:
        description: 'QualitÃ© vidÃ©o'
        required: true
        default: '720p'
        type: choice
        options:
        - 1080p
        - 720p
        - 480p
        - best

jobs:
  youtube-playlist-downloader:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup Environment
      run: |
        echo "ðŸš€ YouTube Playlist Downloader - 1Gbps"
        echo "ðŸ“¹ Playlist URL: ${{ inputs.playlist_url }}"
        echo "ðŸŽ¯ Quality: ${{ inputs.quality }}"
        
    - name: Install YouTube Tools
      run: |
        sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        sudo chmod a+rx /usr/local/bin/yt-dlp
        sudo apt-get update
        sudo apt-get install -y ffmpeg aria2 zip unzip curl
        pip3 install yt-dlp[default]
        
    - name: Configure Maximum Speed
      run: |
        mkdir -p ~/.config/yt-dlp
        cat > ~/.config/yt-dlp/config << EOF
        --no-mtime
        --no-overwrites
        --continue
        --concurrent-fragments 16
        --http-chunk-size 50M
        --external-downloader aria2c
        --external-downloader-args "-x 16 -k 1M -s 16 -j 16"
        --limit-rate 500M
        --retries 10
        --fragment-retries 10
        EOF
        
    - name: Download Playlist
      run: |
        echo "ðŸ“¥ TÃ©lÃ©chargement de la playlist..."
        
        # Configuration format basÃ©e sur la qualitÃ©
        if [ "${{ inputs.quality }}" = "best" ]; then
          FORMAT="bestvideo[height<=1080]+bestaudio/best[height<=1080]"
        elif [ "${{ inputs.quality }}" = "1080p" ]; then
          FORMAT="bestvideo[height<=1080]+bestaudio/best[height<=1080]"
        elif [ "${{ inputs.quality }}" = "720p" ]; then
          FORMAT="bestvideo[height<=720]+bestaudio/best[height<=720]"
        elif [ "${{ inputs.quality }}" = "480p" ]; then
          FORMAT="bestvideo[height<=480]+bestaudio/best[height<=480]"
        else
          FORMAT="bestvideo[height<=720]+bestaudio/best[height<=720]"
        fi
        
        # Commande de tÃ©lÃ©chargement
        yt-dlp \
          --format "$FORMAT" \
          --merge-output-format mp4 \
          --output "playlist_videos/%(title)s.%(ext)s" \
          --concurrent-fragments 32 \
          "${{ inputs.playlist_url }}"
          
        echo "âœ… TÃ©lÃ©chargement terminÃ© !"
        
    - name: Create ZIP Archive
      run: |
        echo "ðŸ—œï¸ CrÃ©ation de l'archive ZIP..."
        zip -r "youtube_playlist.zip" "playlist_videos/" -9
        echo "ðŸ“¦ Archive crÃ©Ã©e: youtube_playlist.zip"
        echo "ðŸ“ Nombre de vidÃ©os: $(find playlist_videos/ -name '*.mp4' | wc -l)"
        
    - name: Upload ZIP as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: youtube-playlist
        path: youtube_playlist.zip
        retention-days: 30
        
    - name: Display Download Summary
      run: |
        echo " "
        echo "ðŸŽ‰ TÃ‰LÃ‰CHARGEMENT TERMINÃ‰ !"
        echo "==================================="
        echo "ðŸ“¹ Playlist: ${{ inputs.playlist_url }}"
        echo "ðŸ’¾ Archive: youtube_playlist.zip" 
        echo "â¬‡ï¸ TÃ©lÃ©charge le ZIP dans l'onglet 'Artifacts'"
        echo "==================================="
