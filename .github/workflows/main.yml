name: YouTube Downloader avec TES Cookies
on:
  workflow_dispatch:
    inputs:
      playlist_url:
        description: 'URL de la playlist YouTube'
        required: true
      quality:
        description: 'Qualit√© vid√©o'
        required: false
        default: 'best'
        type: choice
        options:
        - best
        - 1080p
        - 720p
        - 480p

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Installer yt-dlp et d√©pendances
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip zip
        pip3 install yt-dlp --upgrade
        
    - name: Cr√©er le fichier cookies avec TES cookies
      run: |
        echo "üç™ Cr√©ation du fichier cookies avec TES donn√©es..."
        
        # Cr√©er le fichier cookies exactement comme tu l'as fourni
        cat > cookies.txt << 'EOF'
# Netscape HTTP Cookie File
# https://curl.haxx.se/rfc/cookie_spec.html
# This is a generated file! Do not edit.

.youtube.com	TRUE	/	FALSE	1796420629	HSID	A8XM_f52BFLyhr5B3
.youtube.com	TRUE	/	TRUE	1796420629	SSID	AqP1D6G4pLc7f88Bt
.youtube.com	TRUE	/	FALSE	1796420629	APISID	e-IqRTByZ4RaIq-Q/ApaJSIuJ5Wne8d0TZ
.youtube.com	TRUE	/	TRUE	1796420629	SAPISID	mgaOzZZe281Ea6_q/AYvkZ-qF22xw-35-t
.youtube.com	TRUE	/	TRUE	1796420629	__Secure-1PAPISID	mgaOzZZe281Ea6_q/AYvkZ-qF22xw-35-t
.youtube.com	TRUE	/	TRUE	1796420629	__Secure-3PAPISID	mgaOzZZe281Ea6_q/AYvkZ-qF22xw-35-t
.youtube.com	TRUE	/	TRUE	1795547058	LOGIN_INFO	AFmmF2swRAIgCsYq6oKITKKUbgf5KlRCVY0XXC9Hk1BCkuP0zkWNK3MCIG-aI53OvSx5Yzu3leemSEebTXKBedWxtgdIHnGNS4LC:QUQ3MjNmeEpPc0VycUVuNDM3bVdqcmhROU9CcnRvU3lyYnNrXzFUVy0zYTU4eXl0MFZXcnVwbmdwVUl5RUJlemtudEcwUjBoNWVYWldwenBXM2lXUHlfX3NheEVXOU9hVkFUYkh1WG9nRzdjQWg1aUFvcEJxYVdwcXRsb2xocVhnNWo4TWJGdHIxdWNBVTh2dzU0UmhNTEVvcjM5TnZfNkFB
.youtube.com	TRUE	/	TRUE	1796421663	PREF	f4=4000000&tz=Africa.Casablanca&f7=100
.youtube.com	TRUE	/	FALSE	1796420629	SID	g.a0003AgBksMKpKpSLTostdnqQwGWYpBrZxniIxrwn93SwchGEgZOsj6xENYkrc56nUH9F6O3WAACgYKAZgSARcSFQHGX2Mimux-hozHrkU5dnMIx0r89xoVAUF8yKrgeQYqi2FhG9Oi_cHMP9bm0076
.youtube.com	TRUE	/	TRUE	1796420629	__Secure-1PSID	g.a0003AgBksMKpKpSLTostdnqQwGWYpBrZxniIxrwn93SwchGEgZOCb6GUUTlVhNZ14lGvZMCjgACgYKAaMSARcSFQHGX2MixUc5O-biDgPDvIpquSwR1BoVAUF8yKppaExgDHDAxQAGU13-nI6h0076
.youtube.com	TRUE	/	TRUE	1796420629	__Secure-3PSID	g.a0003AgBksMKpKpSLTostdnqQwGWYpBrZxniIxrwn93SwchGEgZOVV8W_EqfTHurrna6H5K79AACgYKATMSARcSFQHGX2MiwowKIid-WDBmSU-_fD0bThoVAUF8yKrJ55HVzyAxfDr2-MSS-MTv0076
.youtube.com	TRUE	/	TRUE	1793397239	__Secure-1PSIDTS	sidts-CjEBwQ9iI53ZwOcNrs7P-8nlqEQxQQtEeuD8wmlTAB7UMh7wWn1vrkZHY0x_LkfKOUjPEAA
.youtube.com	TRUE	/	TRUE	1793397239	__Secure-3PSIDTS	sidts-CjEBwQ9iI53ZwOcNrs7P-8nlqEQxQQtEeuD8wmlTAB7UMh7wWn1vrkZHY0x_LkfKOUjPEAA
.youtube.com	TRUE	/	FALSE	1793397663	SIDCC	AKEyXzUDHZHZ_Jw3-AX1hDwRcvDGUeQQqM_T7vKCbK2ZHV5q2UP13y03GHTSGLLKwVCWfok-WRo
.youtube.com	TRUE	/	TRUE	1793397663	__Secure-1PSIDCC	AKEyXzUKL7s-6qkTd_YOkD7yZdh0HDBNN13XnnMIeo8iT1qw3vFXIYHi39_nXrOvq14YlRFoXg
.youtube.com	TRUE	/	TRUE	1793397663	__Secure-3PSIDCC	AKEyXzW_xF7qwOP362NuRwDLPfyySOfVnDjnvZL0PEyHWgmjrCmKnLk51vM3nS4CYhzCbzr-ag4
.youtube.com	TRUE	/	TRUE	1777413657	VISITOR_INFO1_LIVE	EsfKh0eQ3S0
.youtube.com	TRUE	/	TRUE	1777413657	VISITOR_PRIVACY_METADATA	CgJNQRIEGgAgZQ%3D%3D
.youtube.com	TRUE	/	TRUE	0	YSC	wva4-DWxd54
.youtube.com	TRUE	/	TRUE	1777401415	__Secure-ROLLOUT_TOKEN	CJ6jh76s24Ss5gEQ_KHM_7uzkAMY1tOexMjMkAM%3D
EOF

        echo "‚úÖ Fichier cookies cr√©√©"
        echo "üìã V√©rification :"
        head -3 cookies.txt
        
    - name: T√©l√©charger la playlist avec cookies
      run: |
        echo "üé¨ D√©but du t√©l√©chargement avec authentification..."
        
        # Configuration qualit√©
        if [ "${{ github.event.inputs.quality }}" = "1080p" ]; then
          FORMAT="best[height<=1080]"
        elif [ "${{ github.event.inputs.quality }}" = "720p" ]; then
          FORMAT="best[height<=720]"
        elif [ "${{ github.event.inputs.quality }}" = "480p" ]; then
          FORMAT="best[height<=480]"
        else
          FORMAT="best"
        fi
        
        yt-dlp \
          --cookies cookies.txt \
          --format "$FORMAT" \
          --merge-output-format mp4 \
          --ignore-errors \
          --no-warnings \
          --restrict-filenames \
          --concurrent-fragments 3 \
          --output "videos/%(playlist_title)s/%(playlist_index)02d - %(title).100s.%(ext)s" \
          "${{ inputs.playlist_url }}"
          
        echo "‚úÖ T√©l√©chargement termin√© avec succ√®s !"
        
    - name: V√©rifier les t√©l√©chargements
      run: |
        echo "üîç V√©rification des fichiers..."
        if [ -d "videos" ]; then
          VIDEO_COUNT=$(find videos/ -name "*.mp4" -type f | wc -l)
          echo "üìπ Nombre de vid√©os t√©l√©charg√©es : $VIDEO_COUNT"
          
          if [ $VIDEO_COUNT -gt 0 ]; then
            echo "üéØ Liste des premi√®res vid√©os :"
            find videos/ -name "*.mp4" -type f | head -5
            echo "üíæ Taille totale : $(du -sh videos/ | cut -f1)"
          else
            echo "‚ùå Aucune vid√©o trouv√©e - v√©rifiez les cookies"
            exit 1
          fi
        else
          echo "‚ùå Dossier videos non trouv√©"
          exit 1
        fi
        
    - name: Cr√©er l'archive ZIP
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        PLAYLIST_NAME=$(find videos/ -maxdepth 1 -type d -name "*" | head -1 | xargs basename 2>/dev/null || echo "youtube_playlist")
        
        echo "üì¶ Cr√©ation de l'archive : ${PLAYLIST_NAME}_${TIMESTAMP}.zip"
        
        zip -r "${PLAYLIST_NAME}_${TIMESTAMP}.zip" "videos/" -9
        
        ZIP_SIZE=$(du -h "${PLAYLIST_NAME}_${TIMESTAMP}.zip" | cut -f1)
        VIDEO_COUNT=$(find videos/ -name "*.mp4" | wc -l)
        
        echo "‚úÖ Archive cr√©√©e : ${PLAYLIST_NAME}_${TIMESTAMP}.zip"
        echo "üìä Taille : $ZIP_SIZE"
        echo "üé¨ Vid√©os : $VIDEO_COUNT"
        
    - name: Upload l'archive ZIP
      uses: actions/upload-artifact@v4
      with:
        name: youtube-playlist-complete
        path: "*.zip"
        retention-days: 7
        
    - name: Nettoyage s√©curis√©
      run: |
        rm -f cookies.txt
        echo "üßπ Cookies supprim√©s pour s√©curit√©"
        
    - name: Message de succ√®s
      run: |
        echo " "
        echo "üéâ SUCC√àS COMPLET !"
        echo "===================="
        echo "üì¶ Le fichier ZIP est disponible dans 'Artifacts'"
        echo "‚¨áÔ∏è  T√©l√©charge-le sur ton PC et d√©compresse-le"
        echo "üîí Les cookies ont √©t√© supprim√©s automatiquement"
        echo " "
