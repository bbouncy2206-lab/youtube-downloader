name: YouTube Downloader avec ZIP
on:
  workflow_dispatch:
    inputs:
      playlist_url:
        description: 'URL playlist YouTube'
        required: true
      quality:
        description: 'QualitÃ© vidÃ©o'
        required: false
        default: 'best'
        type: choice
        options:
        - best
        - 1080p
        - 720p
        - 480p

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Installer yt-dlp BETA et outils
      run: |
        pip3 install --upgrade "https://github.com/yt-dlp/yt-dlp/archive/master.tar.gz"
        sudo apt-get update
        sudo apt-get install -y ffmpeg zip unzip
        
    - name: TÃ©lÃ©chargement avec extractor forcÃ©
      run: |
        # Configuration qualitÃ©
        if [ "${{ github.event.inputs.quality }}" = "1080p" ]; then
          FORMAT="best[height<=1080]"
        elif [ "${{ github.event.inputs.quality }}" = "720p" ]; then
          FORMAT="best[height<=720]"
        elif [ "${{ github.event.inputs.quality }}" = "480p" ]; then
          FORMAT="best[height<=480]"
        else
          FORMAT="best"
        fi
        
        yt-dlp \
        --ignore-errors \
        --no-warnings \
        --extractor-args "youtube:skip=webpage" \
        --extractor-args "youtube:player_client=android,web" \
        --format "$FORMAT" \
        --merge-output-format mp4 \
        --restrict-filenames \
        --output "videos/%(playlist_title)s/%(playlist_index)02d - %(title).100s.%(ext)s" \
        "${{ inputs.playlist_url }}"
        
    - name: VÃ©rifier les tÃ©lÃ©chargements
      run: |
        echo "ğŸ“Š Contenu du dossier videos :"
        find videos/ -type f -name "*.mp4" | head -10
        VIDEO_COUNT=$(find videos/ -type f -name "*.mp4" | wc -l)
        echo "ğŸ¬ Nombre de vidÃ©os tÃ©lÃ©chargÃ©es : $VIDEO_COUNT"
        
        if [ $VIDEO_COUNT -eq 0 ]; then
          echo "âŒ Aucune vidÃ©o tÃ©lÃ©chargÃ©e - tentative alternative..."
          # Fallback simple
          yt-dlp \
          --ignore-errors \
          --format "best[ext=mp4]" \
          --restrict-filenames \
          -o "videos_fallback/%(title)s.%(ext)s" \
          "${{ inputs.playlist_url }}" || true
        fi
        
    - name: CrÃ©er l'archive ZIP organisÃ©e
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        
        # VÃ©rifier quel dossier contient des vidÃ©os
        if [ -d "videos" ] && [ "$(ls -A videos/ 2>/dev/null)" ]; then
          FOLDER="videos"
        elif [ -d "videos_fallback" ] && [ "$(ls -A videos_fallback/ 2>/dev/null)" ]; then
          FOLDER="videos_fallback"
        else
          echo "âŒ Aucune vidÃ©o trouvÃ©e"
          exit 1
        fi
        
        echo "ğŸ“¦ Compression du dossier : $FOLDER"
        
        # CrÃ©er ZIP avec meilleure compression
        zip -r "youtube_playlist_${TIMESTAMP}.zip" "$FOLDER/" -9
        
        # Statistiques
        ZIP_SIZE=$(du -h "youtube_playlist_${TIMESTAMP}.zip" | cut -f1)
        VIDEO_COUNT=$(find "$FOLDER/" -name "*.mp4" | wc -l)
        
        echo "âœ… Archive crÃ©Ã©e : youtube_playlist_${TIMESTAMP}.zip"
        echo "ğŸ“Š Taille : $ZIP_SIZE"
        echo "ğŸ¬ VidÃ©os : $VIDEO_COUNT"
        
    - name: Upload l'archive ZIP
      uses: actions/upload-artifact@v4
      with:
        name: youtube-playlist-zip
        path: youtube_playlist_*.zip
        retention-days: 7
        
    - name: Nettoyage (optionnel)
      run: |
        rm -rf videos/ videos_fallback/
        echo "ğŸ§¹ Nettoyage terminÃ©"
        
    - name: RÃ©sumÃ© final
      run: |
        echo "ğŸ‰ TÃ‰LÃ‰CHARGEMENT TERMINÃ‰ !"
        echo "ğŸ“¦ Fichier ZIP disponible dans l'onglet 'Artifacts'"
        echo "ğŸ’¾ Nom : youtube-playlist-zip"
        echo "â¬‡ï¸  Clique sur le fichier pour le tÃ©lÃ©charger sur ton PC"
