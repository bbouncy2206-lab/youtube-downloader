name: YouTube Playlist Downloader

on:
  workflow_dispatch:
    inputs:
      playlist_url:
        description: 'URL de la playlist YouTube'
        required: true
        type: string

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Installer les dÃ©pendances
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip ffmpeg zip
        pip3 install --upgrade yt-dlp

    - name: CrÃ©er le fichier cookies.txt (NOUVEAUX COOKIES)
      run: |
        cat > cookies.txt << 'EOF'
        # Netscape HTTP Cookie File
        .youtube.com	TRUE	/	FALSE	1796420629	HSID	A8XM_f52BFLyhr5B3
        .youtube.com	TRUE	/	TRUE	1796420629	SSID	AqP1D6G4pLc7f88Bt
        .youtube.com	TRUE	/	FALSE	1796420629	APISID	e-IqRTByZ4RaIq-Q/ApaJSIuJ5Wne8d0TZ
        .youtube.com	TRUE	/	TRUE	1796420629	SAPISID	mgaOzZZe281Ea6_q/AYvkZ-qF22xw-35-t
        .youtube.com	TRUE	/	TRUE	1796420629	__Secure-1PAPISID	mgaOzZZe281Ea6_q/AYvkZ-qF22xw-35-t
        .youtube.com	TRUE	/	TRUE	1796420629	__Secure-3PAPISID	mgaOzZZe281Ea6_q/AYvkZ-qF22xw-35-t
        .youtube.com	TRUE	/	TRUE	1795547058	LOGIN_INFO	AFmmF2swRAIgCsYq6oKITKKUbgf5KlRCVY0XXC9Hk1BCkuP0zkWNK3MCIG-aI53OvSx5Yzu3leemSEebTXKBedWxtgdIHnGNS4LC:QUQ3MjNmeEpPc0VycUVuNDM3bVdqcmhROU9CcnRvU3lyYnNrXzFUVy0zYTU4eXl0MFZXcnVwbmdwVUl5RUJlemtudEcwUjBoNWVYWldwenBXM2lXUHlfX3NheEVXOU9hVkFUYkh1WG9nRzdjQWg1aUFvcEJxYVdwcXRsb2xocVhnNWo4TWJGdHIxdWNBVTh2dzU0UmhNTEVvcjM5TnZfNkFB
        .youtube.com	TRUE	/	TRUE	1796426963	PREF	f4=4000000&tz=Africa.Casablanca&f7=100
        .youtube.com	TRUE	/	FALSE	1796420629	SID	g.a0003AgBksMKpKpSLTostdnqQwGWYpBrZxniIxrwn93SwchGEgZOsj6xENYkrc56nUH9F6O3WAACgYKAZgSARcSFQHGX2Mimux-hozHrkU5dnMIx0r89xoVAUF8yKrgeQYqi2FhG9Oi_cHMP9bm0076
        .youtube.com	TRUE	/	TRUE	1796420629	__Secure-1PSID	g.a0003AgBksMKpKpSLTostdnqQwGWYpBrZxniIxrwn93SwchGEgZOCb6GUUTlVhNZ14lGvZMCjgACgYKAaMSARcSFQHGX2MixUc5O-biDgPDvIpquSwR1BoVAUF8yKppaExgDHDAxQAGU13-nI6h0076
        .youtube.com	TRUE	/	TRUE	1796420629	__Secure-3PSID	g.a0003AgBksMKpKpSLTostdnqQwGWYpBrZxniIxrwn93SwchGEgZOVV8W_EqfTHurrna6H5K79AACgYKATMSARcSFQHGX2MiwowKIid-WDBmSU-_fD0bThoVAUF8yKrJ55HVzyAxfDr2-MSS-MTv0076
        .youtube.com	TRUE	/	TRUE	1793403717	__Secure-1PSIDTS	sidts-CjEBwQ9iI16LG7VWD6Acjas4_HeV-YKy6xe00W29ldPU5N0LZdkDI5C1KPS9Nm6yUzaaEAA
        .youtube.com	TRUE	/	TRUE	1793403717	__Secure-3PSIDTS	sidts-CjEBwQ9iI16LG7VWD6Acjas4_HeV-YKy6xe00W29ldPU5N0LZdkDI5C1KPS9Nm6yUzaaEAA
        .youtube.com	TRUE	/	FALSE	1793403717	SIDCC	AKEyXzX2JYVaG0jFRjB065uzAfIyoHaVH8Z6RrDvHpH0NBYfnR6zFpxWQzfgVTYJN2wPPkGPD9w
        .youtube.com	TRUE	/	TRUE	1793403717	__Secure-1PSIDCC	AKEyXzWRtN8YU31QPLKryFib0oGUh3MHO0Lsi-Y6hvaPM_mh6xNvt8JAyLgf8jUlg2gXsq6Zzw
        .youtube.com	TRUE	/	TRUE	1793403717	__Secure-3PSIDCC	AKEyXzVENXr9NVxZWnMGaHjVsiuwl1dyf8UM1OIf-b5EwN2mK58fSzOWy2ZUqxtRLMrKibfE0sc
        .youtube.com	TRUE	/	TRUE	1777418950	VISITOR_INFO1_LIVE	EsfKh0eQ3S0
        .youtube.com	TRUE	/	TRUE	1777418950	VISITOR_PRIVACY_METADATA	CgJNQRIEGgAgZQ%3D%3D
        .youtube.com	TRUE	/	TRUE	1777401415	__Secure-ROLLOUT_TOKEN	CJ6jh76s24Ss5gEQ_KHM_7uzkAMY1tOexMjMkAM%3D
        .youtube.com	TRUE	/	TRUE	0	YSC	5J19DQJdgXo
        EOF

    - name: VÃ©rifier les cookies
      run: |
        echo "âœ… Fichier cookies crÃ©Ã© : $(wc -l < cookies.txt) lignes"
        echo "ğŸ” Premiers cookies:"
        head -n 3 cookies.txt

    - name: TÃ©lÃ©charger la playlist
      run: |
        mkdir -p downloads
        yt-dlp \
          --cookies cookies.txt \
          --format "best" \
          --ignore-errors \
          --no-warnings \
          --retries 10 \
          --fragment-retries 10 \
          --sleep-interval 3 \
          --max-sleep-interval 8 \
          --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
          --referer "https://www.youtube.com/" \
          --add-header "Accept-Language:en-US,en;q=0.9" \
          --add-header "Accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
          --extractor-args "youtube:player_client=web;player_skip=webpage,configs" \
          -o "downloads/%(playlist_index)s - %(title)s.%(ext)s" \
          "${{ github.event.inputs.playlist_url }}"

    - name: VÃ©rifier les tÃ©lÃ©chargements
      run: |
        echo "ğŸ“Š RÃ©sumÃ© des tÃ©lÃ©chargements:"
        if [ "$(ls -A downloads 2>/dev/null)" ]; then
          echo "âœ… Fichiers tÃ©lÃ©chargÃ©s : $(ls -1 downloads | wc -l)"
          echo "ğŸ’¾ Taille totale : $(du -sh downloads | cut -f1)"
          echo ""
          echo "ğŸ“‹ Liste des fichiers:"
          ls -lh downloads/
        else
          echo "âŒ Aucun fichier tÃ©lÃ©chargÃ©"
          exit 1
        fi

    - name: CrÃ©er l'archive ZIP
      if: success()
      run: |
        cd downloads
        zip -r ../youtube_playlist.zip .
        cd ..
        echo "ğŸ“¦ Archive crÃ©Ã©e : $(du -h youtube_playlist.zip | cut -f1)"

    - name: Upload les vidÃ©os
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: youtube-playlist-${{ github.run_number }}
        path: youtube_playlist.zip
        retention-days: 7

    - name: RÃ©sumÃ© final
      if: always()
      run: |
        echo "======================================"
        if [ -f "youtube_playlist.zip" ]; then
          echo "âœ… SUCCÃˆS - VidÃ©os tÃ©lÃ©chargÃ©es !"
          echo "ğŸ“¦ Fichier ZIP disponible dans les Artifacts"
          echo "ğŸ’¾ Taille : $(du -h youtube_playlist.zip | cut -f1)"
        else
          echo "âŒ Ã‰CHEC - ProblÃ¨me de tÃ©lÃ©chargement"
          echo "ğŸ” VÃ©rifiez que:"
          echo "  - Les cookies sont toujours valides"
          echo "  - La playlist est accessible"
          echo "  - Vous Ãªtes connectÃ© sur YouTube"
        fi
        echo "======================================"
